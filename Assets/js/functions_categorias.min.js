let tableCategorias,rowTable="",divLoading=document.querySelector("#divLoading");document.addEventListener("DOMContentLoaded",function(){tablaCategorias()});
function tablaCategorias(){tableCategorias=$("#tableCategorias").DataTable({destroy:!0,aServerSide:!0,responsive:!0,bProcessing:!0,iDisplayLength:25,order:[[0,"asc"]],language:{url:"https://cdn.datatables.net/plug-ins/1.10.21/i18n/Spanish.json"},ajax:{url:base_url+"categorias/getCategorias",dataSrc:""},columns:[{data:"idcategoria"},{data:"img"},{data:"nombre"},{data:"descripcion"},{data:"options",searchable:!1}],dom:'<"row"<"col-sm-12 col-md-4"l><"col-sm-12 col-md-4"<"dt-buttons btn-group flex-wrap"B>><"col-sm-12 col-md-4"f>>t<"row"<"col-sm-12 col-md-6"i><"col-sm-12 col-md-6"p>>'})}
function alertFoto(b){document.querySelector("#form_alert").innerHTML='<p class="errorArchivo">'+b+".</p>";document.querySelector("#img")&&document.querySelector("#img").remove();document.querySelector("#delPhoto").classList.add("notBlock");foto.value="";return!1}function dataURLtoFile(b,a){var c=b.split(",");b=c[0].match(/:(.*?);/)[1];c=atob(c[1]);let e=c.length,d=new Uint8Array(e);for(;e--;)d[e]=c.charCodeAt(e);return new File([d],a,{type:b})}
function b64toBlob(b,a,c){a=a||"";c=c||512;b=atob(b);let e=[];for(let a=0;a<b.length;a+=c){var d=b.slice(a,a+c);let f=Array(d.length);for(let a=0;a<d.length;a++)f[a]=d.charCodeAt(a);d=new Uint8Array(f);e.push(d)}return new Blob(e,{type:a})}var URL=window.URL||window.webkitURL,image=document.getElementById("img-original"),btncrop=document.getElementById("btn-crop"),cropper=null,ancho=1573,alto=760;
function removePhoto(b=""){document.querySelector("#img"+b)&&document.querySelector("#img"+b).remove();document.querySelector("#foto"+b).value="";document.querySelector("#delPhoto"+b).classList.add("notBlock");document.querySelector("#foto_blob_type"+b).value="";document.querySelector("#foto_blob_name"+b).value=""}let file,img_type,img_name;function formFile(b){}
$("#div-modal-recorte").on("shown.bs.modal",()=>{cropper=new Cropper(image,{minCropBoxWidth:216,minCropBoxHeight:138,zoomOnWheel:!1,zoomable:!1,zoomOnTouch:!1,preview:"#div-preview",viewMode:1,aspectRatio:1.57})}).on("hidden.bs.modal",function(){cropper.destroy();image.src="";cropper=null});file=document.getElementById("foto");
file.addEventListener("change",b=>{if((b=b.target.files)&&0<b.length){img_type=b[0].type;img_name=b[0].name;"image/jpeg"!==img_type&&"image/jpg"!==img_type&&"image/png"!==img_type&&"image/webp"!==img_type&&alertFoto("El archivo debe de ser tipo .jpg/jpeg .png .webp");b=b[0];if(URL)image.src=URL.createObjectURL(b);else if(FileReader){let a=new FileReader;a.onload=function(b){image.src=a.result};a.readAsDataURL(b)}image.onload=()=>{image.width<ancho&&alto<image.height?alertFoto("El tama\u00f1o minimo es de 720x460"):
(document.querySelector("#form_alert").innerHTML="",$("#div-modal-recorte").modal("show"))}}});
btncrop.addEventListener("click",function(){let b=cropper.getCroppedCanvas().toDataURL(img_type),a=new Image;a.src=b;document.querySelector("#prevPhoto div").innerHTML="<img id='img' src="+a.src+">";document.querySelector("#foto_blob_type").value=img_type;document.querySelector("#foto_blob_name").value=img_name;document.querySelector("#delPhoto").classList.remove("notBlock");file.value="";$("#div-modal-recorte").modal("hide");document.querySelector("#foto_remove").value=1;image.src="";reader=null});
document.querySelector("#delPhoto").onclick=b=>{document.querySelector("#foto_remove").value=1;img_name=img_type=document.querySelector("#prevPhoto div").innerHTML="";removePhoto(id)};
function formCategoria(b,a){let c=document.querySelector(`#${b}`+a);c.onsubmit=b=>{b.preventDefault();console.log(c);document.querySelector("#idCategoria"+a);b=document.querySelector("#txtNombre"+a).value;var d=document.querySelector("#txtDescripcion"+a).value;if(""===b||""===d)return Swal.fire("atencion","todos los campos son obligatorios.","error"),!1;b=new FormData(c);d=document.getElementById("foto_blob_name"+a).value;if(""!==d){let c=document.getElementById("img"+a).src;d=dataURLtoFile(c,d);
b.append("foto",d)}$.ajax({url:base_url+"categorias/setCategoria",data:b,type:"POST",contentType:!1,processData:!1,cache:!1,dataType:"json",error:function(a){console.error(a)},success:function(b){b.status?(document.querySelector("#idCategoria"+a).value=b.id,document.querySelector("#acordeon"+a)&&(document.querySelector("#acordeon"+a).innerHTML=`Categoria ${b.id} - ${b.nombre}`),Swal.fire("Categoria de Productos",b.msg,"success"),tableCategorias.ajax.reload(null,!1)):Swal.fire("Error",b.msg,"error")}})}}
function nvaCategoria(){document.querySelector("#idCategoria").value="";document.querySelector(".modal-header").classList.replace("headerUpdate","headerRegister");document.querySelector("#btnActionForm").classList.replace("btn-info","btn-primary");document.querySelector("#titleModal").innerHTML="Nueva Categoria";document.querySelector("#btnText").innerHTML="Guardar";document.querySelector("#formCategoria").reset();document.querySelector("#foto_remove").value="";document.querySelector("#listStatusLabel").hidden=
!0;document.querySelector("#listStatus").hidden=!0;document.querySelector("#pagina_prev").innerHTML="";document.querySelector("#pagina_prox").innerHTML="";document.querySelector("#pagina_poss").innerHTML="";$("#modalFormCategoria").modal("show");removePhoto();formFile("");formCategoria("formCategoria","")}function subcategoriaHtml(b,a,c,e,d="",f="",h="",g,p="",q="",l="",k=0){f=""===f?document.querySelector("#idCategoria").value:f;b+=a;return`
<h2 class="accordion-header" id="heading${a}">
  <button id="acordeon${a}"class="accordion-button fw-medium collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${a}" aria-expanded="false" aria-controls="collapseOne" ${a} >
    subCategoria - ${h} 
  </button>
</h2>
<div id="collapse${a}" class="accordion-collapse collapse" aria-labelledby="heading${a}" data-bs-parent="#accordionSubCategoria${a}" style="">
  <div class="accordion-body">
    <form id="${b}" name="formSubCategoria${a}">
      <input type="hidden" id="idCategoria${a}" name="idCategoria" value="${d}"><!-- este elemento estara oculto y su funcion es setear el id del Categoria a actualizar -->   
      <input type="hidden" id="idCatPadre${f}" name="idCatPadre" value="${f}"><!-- este elemento estara oculto y su funcion es setear el id del Categoria a actualizar -->    
      <div class="p-2">            
        <div class="row">
          <div class="col-lg-6">
            <div class="mb-3">
              <label class="control-label">Nombre <span class="required">*</span></label>
              <input class="form-control" id="txtNombre${a}"name="txtNombre"type="text" placeholder="Ingrese el nombre de la Categoria" required="" value="${h}">
            </div>
            <div class="mb-3">
              <label class="control-label">Descripcion <span class="required">*</span></label>
              <textarea class="form-control" id="txtDescripcion${a}" name="txtDescripcion" rows="4,5" placeholder="Descripcion de la Categoria" required="" >${p}</textarea>
            </div>
          </div>
          <div class="col-lg-6 ">
            <div class="row">
              <div class="d-flex justify-content-center align-middle p-3">
              <input type="hidden" id="foto_actual${a}" name="foto_actual" value="${q}"><!-- -->
              <input type="hidden" id="foto_remove${a}" name="foto_remove" value=""><!-- -->
              <input type="hidden" id="foto_blob_name${a}" name="foto_blob_name" value=""><!-- -->
              <input type="hidden" id="foto_blob_type${a}" name="foto_blob_type" value=""><!-- -->
                <div class="photo"> <!-- Estilos de la imagen -->
                  <label id="prevPhotoLabel${a}"for="foto">Resolucion Minima 500x320)</label>
                  <div id="prevPhoto${a}" class="prevPhoto prevPhoto-subCategoria"> <!-- Donde se mostrara la vistaa previa de la imagen-->
                    <span id="delPhoto${a}" class="delPhoto notBlock">X</span> <!-- no estara visible y se le aplicaran algunos estilos -->
                    <label for="foto"></label> <!-- ocupara el ancho para poder seleccionar la foto -->
                    <div>
                       <img id="imgminiat${a}" src="${media}images/portada_categoria.png"> <!-- imagen previa -->
                    </div>
                  </div>
                  <div class="upimg"> <!-- junto al imput tipo file serviran para cargar la foto -->
                    <input type="file" accept="image/jpg , image/jpeg , image/png" name="foto" id="foto${a}">
                  </div>
                  <div id="form_alert${a}"></div>  <!-- aca se mostrata un texto  -->
                </div>
              </div>
            </div>
          </div>
        </div><!--end row-->
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="listStatus" id="listCatFBLabel">Categoria Facebook <span class="required">*</span></label>
              <select class="form-select" id="listCatFB${a}"name="listCatFB">
                ${c}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="listStatus" id="listCatGoogleLabel">Categoria Google <span class="required">*</span></label>
              <select class="form-select" id="listCatGoogle${a}"name="listCatGoogle">
                ${e}
              </select>
            </div>
          </div>
        </div> <!--end row-->
        <div class="row">
          <!--                              <div class="mt-2 d-flex align-middle">-->
          <div class="col-sm-6 mb-3">
            <div class="mb-3">
              <label class="control-label">Etiquetas </label>
              <input class="form-control" id="txtTags${a}"name="txtTags"type="text" placeholder="Separe las etiquetas por coma  ',' " value="${l}">
            </div>
          </div>
          <div class="col-sm-4 mb-3">
            <label class="control-label">Esatdo </label>
            <select class="form-select pr-5" id="listStatus${a}" name="listStatus" value="${k}">
              <option value="0" ${0===k?"selected":""} > Inactivo</option>
              <option value="1" ${1===k?"selected":""} > Activo</option>
            </select>
          </div>
          <div class="col-sm-2 mb-3">
            <label class="control-label">...................</label>
            <button  type="submit" form="${b}" class="btn btn-primary" >
              <i class="fa fa-check-circle" aria-hidden="true"></i><span id="btnText${a}">&nbsp;Guardar</span></button>
          </div> 
          <!--</div>--> 
        </div>
      </div>
    </form> 
  </div>
</div>
`}
async function nvaSubCategoria(){let b=Date.now(),a=document.querySelector("#accordionCategorias"),c=document.createElement("div");c.classList.add("accordion-item");var e=document.querySelector("#listCatFB").value;let d;await fetch(base_url+"categorias/getCategoriasRS/facebook/"+e+"?activo=0").then(a=>a.text()).then(a=>{d=a});e=document.querySelector("#listCatGoogle").value;let f;await fetch(base_url+"categorias/getCategoriasRS/google/"+e+"?activo=0").then(a=>a.text()).then(a=>{f=a});c.innerHTML=subcategoriaHtml("formSubCategoria",
b,d,f);a.append(c);formFile(b);formCategoria("formSubCategoria",b)}
function fntVer(b){let a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("GET",base_url+"categorias/get/"+b,!0);a.send();a.onreadystatechange=function(){if(4===a.readyState&&200===a.status){let b=JSON.parse(a.responseText);if(b.status){let a=1===b.data.status?'<span class="bagde badge-success">Activo</option>':'<span class="badge badge-danger">Inactivo</option>';document.querySelector("#celID").innerHTML=b.data.idcategoria;document.querySelector("#celNombre").innerHTML=
b.data.nombre;document.querySelector("#celDescripcion").innerHTML=b.data.descripcion;document.querySelector("#celEstado").innerHTML=a;document.querySelector("#celImgCategoria").innerHTML='<img src = "'+b.data.url_img+'">';$("#modalVerCategoria").modal("show")}else Swal.fire("Error",b.msg,"error")}}}
async function fntEdit(b){document.querySelector("#titleModal").innerHTML="Actualizar Categoria";document.querySelector(".modal-header").classList.replace("headerRegister","headerUpdate");document.querySelector("#btnActionForm").classList.replace("btn-primary","btn-info");document.querySelector("#btnText").innerHTML="Actualizar";document.querySelector("#foto_remove").value="";await fetch(base_url+"Categorias/get/"+b).then(a=>a.json()).then(async a=>{if(a.status){document.querySelector("#idCategoria").value=
a.data.idcategoria;document.querySelector("#txtNombre").value=a.data.nombre;let c=a.data.cat_facebook_id;document.querySelector("#listCatFB").value=c;let d=a.data.cat_google_id;document.querySelector("#listCatGoogle").value=d;document.querySelector("#txtDescripcion").value=a.data.descripcion;document.querySelector("#foto_actual").value=a.data.img;document.querySelector("#img")?document.querySelector("#img").src=a.data.url_img:document.querySelector(".prevPhoto div").innerHTML="<img id= 'img' src = '"+
a.data.url_img+"'>";"categorias.png"===a.data.img?document.querySelector("#delPhoto").classList.add("notBlock"):document.querySelector(".delPhoto").classList.remove("notBlock");0===a.data.prev?document.querySelector("#pagina_prev").innerHTML="":document.querySelector("#pagina_prev").innerHTML='<button class="page-item page-link pull-left" onClick="fntEdit('+a.data.prev+')" >\u00ab</button>';0===a.data.prox?document.querySelector("#pagina_prox").innerHTML="":document.querySelector("#pagina_prox").innerHTML=
'<button class="page-item page-link pull-right" onClick="fntEdit('+a.data.prox+')" >\u00bb</button>';document.querySelector("#pagina_poss").innerHTML='<span class="text-primary" >'+a.data.posicion+"</span>";$("#modalFormCategoria").modal("show");formFile("");formCategoria("formCategoria","");a=a.data.subCategorias;let f=a.length,h=document.querySelector("#accordionCategorias");h.innerHTML="";for(let g=0;g<f;g++){let e=a[g].idcategoria,f=a[g].descripcion,l=a[g].idcategoria,k=a[g].img,r=a[g].nombre,
t=a[g].padre_cat_id,u=a[g].ruta,v=a[g].status,w=a[g].tags;var b=a[g].cat_google_id;let m;await fetch(base_url+"categorias/getCategoriasRS/facebook/"+c+"?activo="+a[g].cat_facebook_id).then(a=>a.text()).then(a=>{m=a});let n;await fetch(base_url+"categorias/getCategoriasRS/google/"+d+"?activo="+b).then(a=>a.text()).then(a=>{n=a});b=document.createElement("div");b.classList.add("accordion-item");b.innerHTML=await subcategoriaHtml("formSubCategoria",e,m,n,l,t,r,u,f,k,w,v);h.append(b);await formFile(e);
await formCategoria("formSubCategoria",e)}}else Swal.fire("Error",a.msg,"error")})}
function fntDel(b){Swal.fire({title:"Quieres Eliminar Proveedor",text:"esta accion es irreversible",icon:"warning",showCancelButton:!0,showConfirmButton:!0,cancelButtonText:"No, Cancelar",closeOnConfirm:!1,coseOnCancel:!0}).then(a=>{a.isConfirmed&&fetch(base_url+"categorias/delCategoria/",{method:"POST",headers:{"Content-type":"application/x-www-form-urlencoded"},body:"id="+b}).then(a=>a.json()).then(a=>{a.status?(Swal.fire("HA SIDO UN EXITO",a.msg,"success"),tableCategorias.ajax.reload(null,!1)):
Swal.fire("Atencio!",a.msg,"error")}).catch(a=>console.log(a))})}function fntStatus(b){let a=document.querySelector("#btnStatus"+b);fetch(base_url+"categorias/statusCategoriaChange/?id="+b+"&intStatus="+a.value).then(a=>a.json()).then(b=>{b.status?1==a.value?(a.value=0,a.classList.replace("btn-success","btn-danger")):(a.value=1,a.classList.replace("btn-danger","btn-success")):Swal.fire("Atencion!",b.msg,"error")}).catch(a=>Swal.fire("Atencion!",a,"error"))}
jQuery(document).on("click","a.change-image",function(b){b.preventDefault();jQuery.get(this.href,null,function(a){a=jQuery(a).find("#container_gallery");jQuery("#container_gallery").replaceWith(a)})});